name: Deploy Plugin

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - '.github/**'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'

      - name: Get current version
        id: version
        run: |
          # Extract version from file
          VERSION=$(grep "Version:" udi-custom-login.php | awk '{print $3}')
          echo "CURRENT_VERSION=$VERSION" >> $GITHUB_ENV
          echo "Current version is $VERSION"

      - name: Bump version
        id: bump
        run: |
          # Simple patch bump. Splits 1.0.2 into 1 0 2, increments last, joins back.
          OLD_V=${{ env.CURRENT_VERSION }}
          IFS='.' read -r -a parts <<< "$OLD_V"
          ((parts[2]++))
          NEW_V="${parts[0]}.${parts[1]}.${parts[2]}"
          echo "NEW_VERSION=$NEW_V" >> $GITHUB_ENV
          echo "Bumping to $NEW_V"
          
          # Update file
          sed -i "s/Version: $OLD_V/Version: $NEW_V/" udi-custom-login.php
          sed -i "s/define( 'UDI_LOGIN_VERSION', '$OLD_V' );/define( 'UDI_LOGIN_VERSION', '$NEW_V' );/" udi-custom-login.php

      - name: Commit and Tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add udi-custom-login.php
          git commit -m "Auto-bump version to ${{ env.NEW_VERSION }} [skip ci]"
          git tag "v${{ env.NEW_VERSION }}"
          git push origin main --tags

      - name: Install Dependencies
        run: |
          # Use phar if present, or system composer
          if [ -f composer.phar ]; then
            php composer.phar install --no-dev --optimize-autoloader
          else
            composer install --no-dev --optimize-autoloader
          fi

      - name: Build ZIP
        run: |
          mkdir build
          # Create zip excluding dev files
          zip -r build/udi-custom-login.zip . -x "*.git*" "*.github*" "composer.phar" "composer.lock" "test-google-config.php" "validate.php" ".DS_Store" "emergency-fix.php"

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.NEW_VERSION }}
          files: build/udi-custom-login.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
